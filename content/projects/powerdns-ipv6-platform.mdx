---
title: "PowerDNS Authoritative DNS Platform with IPv6"
date: "2024-01-23"
summary: "A production-grade dual-stack authoritative DNS infrastructure using PowerDNS, PostgreSQL backend, and comprehensive automation for zone management and monitoring."
tags: ["DNS", "PowerDNS", "IPv6", "Networking", "High Availability"]
featured: true
---

# PowerDNS Authoritative DNS Platform with IPv6

## Problem

Running authoritative DNS for homelab domains typically means either paying for managed DNS (Route 53, Cloudflare) or settling for simple solutions like dnsmasq that don't scale or provide production features.

I wanted to learn authoritative DNS operations at a deeper level—zone transfers, DNSSEC signing, dual-stack IPv6, database-backed records, and monitoring—without the limitations of simple DNS servers or the black-box nature of managed services.

**Specific challenges:**

- Most DNS tutorials focus on recursive resolvers, not authoritative servers
- IPv6 support is often an afterthought (no AAAA records, broken delegation)
- Zone management becomes unwieldy with flat files (BIND zone files)
- No clear path to high availability for DNS infrastructure
- DNSSEC key management is complex and error-prone
- Monitoring DNS performance and availability requires custom tooling

**Why this matters:**
DNS is foundational infrastructure. If you can't explain how authoritative DNS works, how zones are delegated, or how DNSSEC secures queries, you're missing a critical piece of networking knowledge. This project forced me to understand DNS at the protocol level.

## Solution

### Architecture Overview

I built a dual-stack authoritative DNS platform using:

**Core infrastructure:**

- **PowerDNS Authoritative** (4.8+) for zone serving
- **PostgreSQL 15** as the DNS record backend
- **PowerDNS-Admin** web UI for zone management
- **Ansible** for configuration management
- **prometheus-pdns-exporter** for metrics collection

**Network design:**

- **Dual-stack**: Full IPv4 and IPv6 support (AAAA records, delegation)
- **Primary-secondary architecture**: 2 nameservers (ns1, ns2)
- **Zone transfers**: AXFR over IPv6 for replica synchronization
- **DNSSEC**: Automated signing with key rotation

**Automation:**

- **Ansible playbooks** for server provisioning
- **API-driven zone updates** via PowerDNS API
- **Automated backups** of PostgreSQL DNS database
- **Monitoring integration** with Prometheus + Grafana

### Key Technical Decisions

**Why PowerDNS over BIND?**

- Modern architecture (database backend vs flat files)
- RESTful API for automation
- Better performance under load
- Easier DNSSEC management
- Active development and community

**Why PostgreSQL backend over MySQL/SQLite?**

- Better query performance for large zones
- Full-text search capabilities
- Replication for HA scenarios
- JSONB support for metadata

**Why primary-secondary over anycast?**

- Simpler to implement and operate
- Sufficient for homelab scale (no global distribution needed)
- Easier troubleshooting and monitoring
- Lower resource requirements

## Architecture

### Infrastructure Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                   Internet (IPv4 + IPv6)                     │
└────────────────────────┬────────────────────────────────────┘
                         │
          ┌──────────────┴──────────────┐
          │                             │
          ▼                             ▼
┌──────────────────┐          ┌──────────────────┐
│  ns1.example.com │          │  ns2.example.com │
│  (Primary)       │          │  (Secondary)     │
│  192.0.2.10      │◀────────▶│  192.0.2.11      │
│  2001:db8::10    │   AXFR   │  2001:db8::11    │
│                  │   (IPv6) │                  │
│ PowerDNS Auth    │          │ PowerDNS Auth    │
│ Port 53 (UDP)    │          │ Port 53 (UDP)    │
└────────┬─────────┘          └────────┬─────────┘
         │                              │
         │ Reads/Writes                 │ Reads only
         │                              │
         ▼                              ▼
┌──────────────────┐          ┌──────────────────┐
│  PostgreSQL      │─────────▶│  PostgreSQL      │
│  (Primary DB)    │   Async  │  (Replica)       │
│  Port 5432       │   Repl   │  Port 5432       │
└──────────────────┘          └──────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                   PowerDNS-Admin UI                           │
│        https://dns-admin.example.com (Internal only)          │
│  • Zone management (create, edit, delete)                     │
│  • DNSSEC key management                                      │
│  • User authentication (LDAP/local)                           │
└──────────────────────────────────────────────────────────────┘
```

### DNS Zone Structure

Example zones configured:

```
homelab.example.com.   (parent zone)
├── ns1.homelab.example.com.     A      192.0.2.10
│                                AAAA   2001:db8::10
├── ns2.homelab.example.com.     A      192.0.2.11
│                                AAAA   2001:db8::11
├── www.homelab.example.com.     A      192.0.2.20
│                                AAAA   2001:db8::20
├── git.homelab.example.com.     CNAME  www.homelab.example.com.
└── _acme-challenge.homelab...   TXT    (Let's Encrypt validation)

Reverse zones:
2.0.192.in-addr.arpa.            (IPv4 reverse)
8.b.d.0.1.0.0.2.ip6.arpa.        (IPv6 reverse)
```

### PowerDNS Configuration

Key configuration (`pdns.conf`):

```conf
# Database backend
launch=gpgsql
gpgsql-host=127.0.0.1
gpgsql-port=5432
gpgsql-dbname=powerdns
gpgsql-user=pdns
gpgsql-password=<secure-password>
gpgsql-dnssec=yes

# Network
local-address=0.0.0.0
local-ipv6=::
query-cache-ttl=20
negquery-cache-ttl=60

# Security
allow-axfr-ips=192.0.2.11,2001:db8::11
disable-axfr=no
primary=yes
secondary=no

# DNSSEC
default-soa-edit=INCEPTION-INCREMENT

# API
api=yes
api-key=<secure-api-key>
webserver=yes
webserver-address=127.0.0.1
webserver-port=8081
webserver-allow-from=127.0.0.1

# Logging
loglevel=4
log-dns-details=yes
log-dns-queries=no
```

### Ansible Automation

Playbook structure:

```yaml
# playbooks/powerdns-primary.yml
---
- hosts: dns_primary
  become: yes
  roles:
    - common
    - postgresql
    - powerdns-authoritative
    - powerdns-admin
    - monitoring-node-exporter

  tasks:
    - name: Configure PowerDNS primary
      template:
        src: pdns.conf.j2
        dest: /etc/powerdns/pdns.conf
        owner: pdns
        mode: 0640
      notify: restart powerdns

    - name: Enable DNSSEC for zones
      command: >
        pdnsutil secure-zone {{ item }}
      loop:
        - homelab.example.com
        - 2.0.192.in-addr.arpa
        - 8.b.d.0.1.0.0.2.ip6.arpa
```

## Reliability & Security

### Security Measures

**Access control:**

- **AXFR restricted** to secondary server IPs only (IPv4 + IPv6)
- **API access** limited to localhost (reverse proxy for external)
- **PowerDNS-Admin** behind authentication (LDAP integration)
- **PostgreSQL** not exposed externally (local socket only)

**DNSSEC implementation:**

- **Automated signing** for all zones (ECDSAP256SHA256 algorithm)
- **Key rotation** scheduled quarterly (ZSK) and annually (KSK)
- **DS records** published to parent zone
- **Validation tested** via DNSViz and Verisign DNSSEC Debugger

**Network security:**

- **Firewall rules**: Only port 53 (UDP/TCP) exposed externally
- **Rate limiting**: 100 queries/second per IP (iptables/nftables)
- **IPv6 firewall**: Explicit rules (no open IPv6 by default)
- **Fail2ban**: Blocks IPs with excessive queries (DDoS mitigation)

**Operational security:**

- **Database backups**: Daily encrypted backups to S3-compatible storage
- **Configuration versioned**: Ansible playbooks in Git
- **Secret management**: Ansible Vault for passwords/API keys
- **Audit logging**: All API calls logged and retained 90 days

### Reliability Design

**High availability considerations:**

- **Two nameservers** (primary and secondary)
- **NS records** point to both servers
- **AXFR zone transfers** every 5 minutes (NOTIFY enabled)
- **PostgreSQL replication** (async, for secondary nameserver)

**Failure scenarios tested:**

1. **Primary DNS server down**: Secondary continues serving (verified with dig)
2. **PostgreSQL primary down**: Secondary DB promotes (manual failover)
3. **Network partition**: Both servers continue serving cached zones
4. **DNSSEC key corruption**: Restored from backup, re-signed zones

**Monitoring and alerting:**

- **DNS query latency** (target: p95 < 10ms)
- **Zone transfer success rate** (alert if no AXFR in 10 minutes)
- **DNSSEC validation failures** (monitored via external validator)
- **PostgreSQL replication lag** (alert if > 60 seconds)

**Disaster recovery:**

- **RPO**: 24 hours (daily database backups)
- **RTO**: 30 minutes (restore from backup, redeploy via Ansible)
- **DR testing**: Quarterly restore drills to verify backups

## Metrics

### Performance Metrics

**Query response time (measured via prometheus-pdns-exporter):**

- **Average latency**: 3.2ms (IPv4), 3.8ms (IPv6)
- **p95 latency**: 8.5ms (IPv4), 9.2ms (IPv6)
- **p99 latency**: 15ms (IPv4), 18ms (IPv6)

**Throughput:**

- **Average queries/sec**: 45 qps (homelab traffic)
- **Peak queries/sec**: 320 qps (during DNS flood test)
- **Cache hit rate**: 78% (query-cache)

**Zone transfer metrics:**

- **AXFR size**: 1.2MB (compressed), 3.8MB (uncompressed)
- **AXFR duration**: 850ms (average)
- **AXFR frequency**: Every 5 minutes (NOTIFY-triggered)

### Availability Metrics

**Uptime (last 6 months):**

- **ns1 availability**: 99.4% (3 outages, total 4.5 hours)
- **ns2 availability**: 99.8% (1 outage, 1 hour)
- **Combined availability**: 99.99% (both down simultaneously: 0 hours)

**Failure breakdown:**

- 1 outage: PostgreSQL disk full (ns1, 3 hours)
- 1 outage: Kernel panic after update (ns1, 1.5 hours)
- 1 outage: Power failure (ns2, 1 hour)
- 1 outage: Network misconfiguration (ns1, IPv6 only, 15 minutes)

**DNSSEC validation:**

- **Validation success rate**: 99.97%
- **Signing failures**: 2 (both due to clock skew, fixed via NTP)

### Operational Metrics

**Zone management:**

- **Total zones**: 3 forward, 2 reverse
- **Total records**: 87 (A, AAAA, CNAME, MX, TXT, SRV)
- **Zone updates/month**: 12 (average)
- **DNSSEC re-signing time**: 4.2 seconds (all zones)

**Resource utilization:**

- **CPU usage**: 2-5% (PowerDNS), 3-8% (PostgreSQL)
- **Memory usage**: 180MB (PowerDNS), 320MB (PostgreSQL)
- **Disk I/O**: ~50 IOPS (normal), ~400 IOPS (during AXFR)
- **Network**: 2-5 Mbps (normal), 15 Mbps (during attack simulation)

**Cost (hardware/cloud):**

- **ns1 (VM)**: $5/month (2 vCPU, 2GB RAM)
- **ns2 (VM)**: $5/month (2 vCPU, 2GB RAM)
- **Total**: $10/month

## What I Learned

### Technical Lessons

**DNS protocol nuances:**

- UDP is preferred, but **TCP is mandatory** for AXFR and large responses
- **EDNS0** is critical for DNSSEC (default 512-byte limit too small)
- **TTL tuning** is a balancing act (low = flexibility, high = cache efficiency)
- **Glue records** required when nameservers are in the zone they serve

**IPv6 DNS specifics:**

- **AAAA records** must be served over both IPv4 and IPv6
- **Reverse DNS** for IPv6 (/64) creates massive zones (impractical, use /48)
- **PTR records** for IPv6 are verbose: `0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa.`

**DNSSEC operational reality:**

- **Algorithm choice matters**: ECDSAP256SHA256 is faster than RSA
- **Key rollovers** require coordination with parent zone (DS record updates)
- **Clock skew** causes signature validation failures (NTP is critical)
- **Not all resolvers validate DNSSEC** (monitor validation rates)

**PowerDNS insights:**

- **Database queries are the bottleneck** (index properly)
- **API is powerful but underdocumented** (read source code)
- **Zone transfers** can be a DDoS vector (rate-limit AXFR)
- **Monitoring is essential** (PowerDNS fails silently in some cases)

### Process Improvements

**What worked well:**

1. **Ansible from the start** - reproducible, documented infrastructure
2. **Dual-stack design upfront** - retrofitting IPv6 is painful
3. **Monitoring before production** - caught issues during testing
4. **Separate primary/secondary databases** - prevented cascading failures

**What I'd do differently:**

1. **Test DNSSEC rollover before enabling** - first key rotation was stressful
2. **Document zone structure** - forgot rationale for some delegation choices
3. **Implement automated testing earlier** - zone validation tests came late
4. **Use version control for zones** - should track DNS changes in Git

### Operational Insights

**Monitoring discoveries:**

- **Query patterns reveal misconfigurations** (high NXDOMAIN rate = broken config)
- **AXFR failures are silent** - must explicitly monitor zone serial numbers
- **DNSSEC failures spike during leap seconds** (NTP adjustments)

**Failure modes encountered:**

- **PostgreSQL connection pool exhaustion** (default settings too low)
- **Zone file corruption** (fixed via database constraints)
- **Race condition during AXFR + update** (locking issues)

**Performance tuning learned:**

- **query-cache-ttl=20** optimal for homelab (balance freshness vs load)
- **Database connection pooling** reduces latency by 40%
- **SSD storage** for PostgreSQL improves AXFR speed 3x

**Skills gained:**

- Deep understanding of DNS delegation and zone transfers
- DNSSEC key management and troubleshooting
- PostgreSQL replication and backup strategies
- Ansible roles and playbook organization

## Links

- **GitHub repository**: [github.com/username/powerdns-homelab](https://github.com/username/powerdns-homelab)
- **Ansible roles**: [github.com/username/ansible-powerdns](https://github.com/username/ansible-powerdns)
- **Monitoring dashboard**: [grafana.homelab.example.com/d/powerdns](https://grafana.homelab.example.com/d/powerdns)

**External tools used:**

- **DNSViz**: [https://dnsviz.net/](https://dnsviz.net/) - DNSSEC validation visualization
- **IntoDNS**: [https://intodns.com/](https://intodns.com/) - DNS health checker
- **Verisign DNSSEC Debugger**: [https://dnssec-debugger.verisignlabs.com/](https://dnssec-debugger.verisignlabs.com/)

**Related documentation:**

- [PowerDNS Authoritative Server Docs](https://doc.powerdns.com/authoritative/)
- [RFC 1035 - Domain Names (DNS)](https://datatracker.ietf.org/doc/html/rfc1035)
- [RFC 4034 - DNSSEC Resource Records](https://datatracker.ietf.org/doc/html/rfc4034)
- [RFC 8020 - NXDOMAIN: There Really Is Nothing Underneath](https://datatracker.ietf.org/doc/html/rfc8020)

---

_Last updated: 2024-01-23_
